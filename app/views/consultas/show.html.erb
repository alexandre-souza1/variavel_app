<div class="driver-report-container">
  <div class="header bg-primary text-white py-4 mb-4 rounded-bottom">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-0">Relatório de Variável</h1>
        </div>
        <div class="col-md-4 text-md-end">
          <%= link_to "Voltar", root_path, class: "btn btn-light" %>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Informações do Motorista -->
    <div class="card driver-info-card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h2 class="driver-name"><%= @driver.nome %></h2>
            <p class="driver-id">Matrícula: <%= @driver.matricula %></p>
          </div>
          <div class="col-md-6 text-md-end">
            <% if @data_inicio && @data_fim && @dias_periodo %>
              <div class="period-info">
                <p class="mb-1"><strong>Período:</strong> <%= @data_inicio.strftime("%d/%m/%Y") %> a <%= @data_fim.strftime("%d/%m/%Y") %></p>
                <p class="mb-0"><strong>Dias:</strong> <%= @dias_periodo %></p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Aviso Importante -->
    <div class="alert alert-warning mb-4">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      Segue prévia da variável no novo modelo de RV. Os valores podem variar, especialmente nos casos motorista que tenha sido alocado como ajudante ou extra. Em caso de inconsistência, contatar a supervisão. Variável para viagens ROTA.
    </div>

    <!-- Tabela de Mapas -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="mb-0">Detalhes dos Mapas</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-primary">
              <tr>
                <th>Mapa</th>
                <th>Data</th>
                <th>Fator</th>
                <th>Cx Total</th>
                <th>Cx Real</th>
                <th>PDV Total</th>
                <th>PDV Real</th>
                <th>REC</th>
                <th>Valor CX</th>
                <th>Valor PDV</th>
                <th>Valor REC</th>
                <th>Valor MP</th>
              </tr>
            </thead>
            <tbody>
              <% total_cx_real = 0 %>
              <% total_valor_cx = 0 %>
              <% total_pdv_real = 0 %>
              <% total_valor_pdv = 0 %>
              <% total_recarga = 0 %>
              <% total_valor_rec = 0 %>
              <% total_valor_mp = 0 %>
              <% total_mapas = 0 %>

              <% @mapas.each do |mapa| %>
                <% valor_cx = (mapa.fator == 0 && mapa.pdv_total.to_i >= 2) ? mapa.cx_real.to_i * 0.12 * 2 : mapa.cx_real.to_i * 0.12 %>
                <% valor_pdv = (mapa.fator == 0 && mapa.pdv_total.to_i >= 2) ? mapa.pdv_real.to_i * 0.76 * 2 : mapa.pdv_real.to_i * 0.76 %>
                <% valor_rec = mapa.recarga == "SIM" ? 150 : 0 %>
                <% valor_mp = mapa.recarga == "SIM" ? valor_rec : (valor_cx + valor_pdv) %>

                <% total_cx_real += mapa.cx_real.to_i %>
                <% total_valor_cx += valor_cx %>
                <% total_pdv_real += mapa.pdv_real.to_i %>
                <% total_valor_pdv += valor_pdv %>
                <% total_recarga += 1 if mapa.recarga == "SIM" %>
                <% total_valor_rec += valor_rec %>
                <% total_valor_mp += valor_mp %>
                <% total_mapas += 1 %>

                <tr>
                  <td><%= mapa.mapa %></td>
                  <td>
                    <% if mapa.data.present? && mapa.data.match?(/^\d{8}$/) %>
                      <%= Date.strptime(mapa.data, "%d%m%Y").strftime("%d/%m/%Y") %>
                    <% else %>
                      <%= mapa.data %>
                    <% end %>
                  </td>
                  <td><%= mapa.fator %></td>
                  <td><%= mapa.cx_total %></td>
                  <td><%= mapa.cx_real %></td>
                  <td><%= mapa.pdv_total %></td>
                  <td><%= mapa.pdv_real %></td>
                  <td><%= mapa.recarga %></td>
                  <td><%= number_to_currency(valor_cx, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  <td><%= number_to_currency(valor_pdv, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  <td><%= number_to_currency(valor_rec, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  <td><%= number_to_currency(valor_mp, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Painel de Totais -->
    <div class="row">
      <div class="col-md-8">
        <div class="card total-card mb-4">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Painel de Totais</h3>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th></th>
                    <th>Quantidade</th>
                    <th>Valor Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Cx Real</td>
                    <td><%= total_cx_real %></td>
                    <td><%= number_to_currency(total_valor_cx, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  </tr>
                  <tr>
                    <td>PDV Real</td>
                    <td><%= total_pdv_real %></td>
                    <td><%= number_to_currency(total_valor_pdv, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  </tr>
                  <tr>
                    <td>Recargas</td>
                    <td><%= total_recarga %></td>
                    <td><%= number_to_currency(total_valor_rec, unit: "R$ ", separator: ",", delimiter: ".") %></td>
                  </tr>
                  <tr>
                    <td>Mapas</td>
                    <td><%= total_mapas %></td>
                    <td><strong><%= number_to_currency(total_valor_mp, unit: "R$ ", separator: ",", delimiter: ".") %></strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Parâmetros de Cálculo -->
      <div class="col-md-4">
        <div class="card parameters-card">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Parâmetros de Cálculo</h3>
          </div>
          <div class="card-body">
            <% if @valor_caixa && @valor_entrega && @valor_recarga %>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Caixa Real
                  <span class="badge bg-primary rounded-pill"><%= number_to_currency(@valor_caixa, unit: "R$ ", separator: ",", delimiter: ".") %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  PDV Real (Entrega)
                  <span class="badge bg-primary rounded-pill"><%= number_to_currency(@valor_entrega, unit: "R$ ", separator: ",", delimiter: ".") %></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Recarga
                  <span class="badge bg-primary rounded-pill"><%= number_to_currency(@valor_recarga, unit: "R$ ", separator: ",", delimiter: ".") %></span>
                </li>
              </ul>
            <% else %>
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-octagon-fill me-2"></i>
                Os valores de cálculo não estão disponíveis no momento. Por favor, tente novamente mais tarde.
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
