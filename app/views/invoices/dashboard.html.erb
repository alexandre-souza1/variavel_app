<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>ðŸ“Š Dashboard Financeiro</h1>

  <div class="d-flex align-items-center gap-2">
    <%= form_with url: dashboard_invoices_path, method: :get, local: true, class: "d-flex justify-content-between gap-2" do %>
      <%= select_tag :month,
          options_for_select((1..12).map { |m| [I18n.t("date.month_names")[m], m] }, params[:month]),
          include_blank: "MÃªs",
          class: "form-select" %>

      <%= select_tag :year,
          options_for_select((2022..Date.today.year).to_a.reverse, params[:year]),
          include_blank: "Ano",
          class: "form-select" %>

      <%= submit_tag "Filtrar", class: "btn btn-outline-primary" %>
    <% end %>

    <%= link_to "Limpar filtros", dashboard_invoices_path, class: "btn btn-outline-primary" %>
  </div>
</div>

<!-- Cards de Resumo -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white shadow-sm">
      <div class="card-body text-center">
        <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
        <h5>Total Geral</h5>
        <p class="fs-4 fw-bold">R$ <%= number_to_currency(@total_spent, unit: "", separator: ",", delimiter: ".") %></p>
        <small><%= @invoices_count %> notas fiscais</small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card bg-success text-white shadow-sm">
      <div class="card-body text-center">
        <i class="fas fa-calendar-day fa-2x mb-2"></i>
        <h5>Este MÃªs</h5>
        <p class="fs-4 fw-bold">R$ <%= number_to_currency(@current_month_total, unit: "", separator: ",", delimiter: ".") %></p>
        <small><%= @current_month_count %> notas este mÃªs</small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card bg-info text-white shadow-sm">
      <div class="card-body text-center">
        <i class="fas fa-building fa-2x mb-2"></i>
        <h5>Fornecedores</h5>
        <p class="fs-4 fw-bold"><%= @suppliers_count %></p>
        <small>ativos</small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card bg-warning text-white shadow-sm">
      <div class="card-body text-center">
        <i class="fas fa-chart-line fa-2x mb-2"></i>
        <h5>MÃ©dia Mensal</h5>
        <p class="fs-4 fw-bold">R$ <%= number_to_currency(@monthly_average, unit: "", separator: ",", delimiter: ".") %></p>
        <small>mÃ©dia dos Ãºltimos 6 meses</small>
      </div>
    </div>
  </div>
</div>


<!-- Gastos por Categoria do PerÃ­odo -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Gastos por Categoria - <%= @period_display %></h6>
      </div>
      <div class="card-body">
        <% if @has_period_filter %>
          <div class="row">
            <% if @current_month_categories.any? %>
              <% @current_month_categories.each do |category_data| %>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                      <div class="mb-2">
                        <span class="badge bg-<%= category_color(category_data[:category]) %> p-2">
                          <i class="fas fa-<%= category_icon(category_data[:category]) %> fa-lg"></i>
                        </span>
                      </div>
                      <h6 class="card-title text-truncate"><%= category_data[:category].name.titleize %></h6>
                      <p class="card-text fw-bold text-primary fs-5">
                        R$ <%= number_to_currency(category_data[:total], unit: "", separator: ",", delimiter: ".") %>
                      </p>
                      <small class="text-muted">
                        <%= category_data[:count] %> <%= category_data[:count] == 1 ? 'nota' : 'notas' %>
                      </small>
                      <% if @period_total > 0 %>
                        <div class="progress mt-2" style="height: 6px;">
                          <div class="progress-bar bg-<%= category_color(category_data[:category]) %>"
                               style="width: <%= (category_data[:total] / @period_total * 100).round(1) %>%"
                               title="<%= (category_data[:total] / @period_total * 100).round(1) %>% do total do perÃ­odo">
                          </div>
                        </div>
                        <small class="text-muted mt-1 d-block">
                          <%= (category_data[:total] / @period_total * 100).round(1) %>%
                        </small>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="col-12 text-center py-4">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">Nenhuma nota fiscal encontrada para <%= @period_display %>.</p>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-5">
            <i class="fas fa-filter fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Selecione o mÃªs e ano no filtro</h5>
            <p class="text-muted">Use os filtros acima para visualizar os gastos por categoria de um perÃ­odo especÃ­fico.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>


<!-- GrÃ¡ficos em Grid -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>DistribuiÃ§Ã£o por Categoria</h6>
      </div>
      <div class="card-body">
        <%= pie_chart @spent_per_category,
                      donut: true,
                      colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>EvoluÃ§Ã£o Mensal</h6>
      </div>
      <div class="card-body">
        <%= line_chart @monthly_totals,
                      colors: ['#36A2EB'],
                      curve: false,
                      xtitle: "MÃªs",
                      ytitle: "Valor (R$)" %>
      </div>
    </div>
  </div>
</div>

<!-- Top Fornecedores -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>Top 5 Fornecedores</h6>
      </div>
      <div class="card-body">
        <div class="list-group">
          <% @top_suppliers.each do |supplier| %>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= supplier.name %></strong>
                <br>
                <small class="text-muted"><%= supplier.invoices_count %> notas</small>
              </div>
              <span class="badge bg-primary rounded-pill">
                R$ <%= number_to_currency(supplier.total_amount, unit: "", separator: ",", delimiter: ".") %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Alertas e PendÃªncias</h6>
      </div>
      <div class="card-body">
        <% if @recent_invoices.any? %>
          <div class="alert alert-warning">
            <i class="fas fa-clock me-2"></i>
            <strong><%= @recent_invoices.count %> notas</strong> dos Ãºltimos 7 dias
          </div>
        <% end %>

        <% if @high_value_invoices.any? %>
          <div class="alert alert-info">
            <i class="fas fa-money-bill-wave me-2"></i>
            <strong><%= @high_value_invoices.count %> notas</strong> acima de R$ 10.000
          </div>
        <% end %>

        <div class="alert alert-light">
          <i class="fas fa-chart-line me-2"></i>
          VariaÃ§Ã£o mensal:
          <span class="<%= @monthly_variation >= 0 ? 'text-success' : 'text-danger' %>">
            <%= @monthly_variation %>% em relaÃ§Ã£o ao mÃªs anterior
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ãšltimos LanÃ§amentos com Filtros -->
<div class="card shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Ãšltimos LanÃ§amentos</h6>
    <div>
      <small class="text-muted me-3">Mostrando <%= @latest_invoices.count %> de <%= @total_invoices_count %> notas</small>
      <%= link_to "Ver Todas", invoices_path, class: "btn btn-sm btn-outline-primary" %>
    </div>
  </div>
  <div class="card-body">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Fornecedor</th>
          <th>NFs</th>
          <th>Data</th>
          <th>Categoria</th>
          <th>Centro de Custo</th>
          <th>Valor</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        <% @latest_invoices.each do |invoice| %>
          <tr>
            <td>
              <strong><%= invoice.supplier.name %></strong>
              <br>
              <small class="text-muted"><%= invoice.supplier.cnpj %></small>
            </td>
            <td>
              <% invoice.invoice_numbers.each do |num| %>
                <span class="badge bg-info"><%= num.number %></span>
              <% end %>
            </td>
            <td><%= l(invoice.date_issued, format: :short) %></td>
            <td>
              <span class="badge bg-<%= category_color(invoice.budget_category) %>">
                <%= invoice.budget_category.name.titleize %>
              </span>
            </td>
            <td>
              <span class="badge bg-secondary">
                <%= invoice.cost_center.name.titleize %>
              </span>
            </td>
            <td class="fw-bold text-success">
              R$ <%= number_to_currency(invoice.total, unit: "", separator: ",", delimiter: ".") %>
            </td>
            <td>
              <%= link_to invoice_path(invoice), class: "btn btn-sm btn-outline-primary", title: "Ver detalhes" do %>
                <i class="fas fa-eye"></i>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
<%= link_to "Voltar", invoices_path, class: "btn btn-primary shadow-sm p-3 w-100 mt-2" %>
