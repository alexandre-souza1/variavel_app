<div class="container my-5">
  <% if notice %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= notice %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Lançamentos de NF's e Boletos</h1>
    <div class="d-flex gap-2">
      <%= link_to "Dashboard", dashboard_invoices_path, class: "btn btn-secondary" %>
      <%= link_to "Novo Lançamento", new_invoice_path, class: "btn btn-primary" %>
      <%= link_to "Fornecedores", suppliers_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Formulário de filtro -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: invoices_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-2">
          <%= f.label :id, "ID do Lançamento", class: "form-label" %>
          <%= f.number_field :id, value: params[:id], class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :supplier_cnpj, "CNPJ do Fornecedor", class: "form-label" %>
          <%= f.text_field :supplier_cnpj, value: params[:supplier_cnpj], class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :date_issued, "Data de Emissão", class: "form-label" %>
          <%= f.date_field :date_issued, value: params[:date_issued], class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :due_date, "Data de Vencimento", class: "form-label" %>
          <%= f.date_field :due_date, value: params[:due_date], class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :total, "Valor", class: "form-label" %>
          <%= f.number_field :total, value: params[:total], step: "0.01", class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :invoice_number, "Número da NF", class: "form-label" %>
          <%= f.text_field :invoice_number, value: params[:invoice_number], class: "form-control" %>
        </div>

        <div class="col-12 mt-2">
          <%= f.submit "Filtrar", class: "btn btn-outline-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Tabela de invoices -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Código</th>
          <th>Fornecedor (CNPJ)</th>
          <th>Data Emissão</th>
          <th>Data Vencimento</th>
          <th>Total</th>
          <th>Notas Fiscais</th>
          <th>Arquivos</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% @invoices.each do |invoice| %>
          <tr>
            <td><%= invoice.code %></td>
            <td><%= invoice.supplier.name %> (<%= invoice.supplier.cnpj %>)</td>
            <td><%= invoice.date_issued %></td>
            <td><%= invoice.due_date %></td>
            <td>R$ <%= number_with_precision(invoice.total, precision: 2, delimiter: ".") %></td>
            <td>
              <%= invoice.invoice_numbers.map(&:number).join(", ") %>
            </td>
            <td>
              <% if invoice.document_urls.present? %>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" id="dropdownMenuButton<%= invoice.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-download"></i>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton<%= invoice.id %>">
                    <% invoice.document_urls.each_with_index do |url, index| %>
                      <li>
                        <%= link_to download_document_invoice_path(invoice, document_index: index),
                                    class: "dropdown-item",
                                    data: { turbo: false } do %>
                          <i class="fas fa-file"></i> Documento <%= index + 1 %>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% else %>
                <span>-</span>
              <% end %>
            </td>
            <td>
              <div class="d-inline-flex gap-2">
                <%= link_to "Ver", invoice, class: "btn btn-sm btn-outline-secondary" %>
                <%= link_to "Editar", edit_invoice_path(invoice), class: "btn btn-sm btn-outline-primary" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <%= link_to "Voltar", root_path, class: "btn btn-primary shadow-sm p-3 w-100 mt-2" %>
</div>
