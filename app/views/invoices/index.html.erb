<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Lançamentos de NF's e Boletos</h1>
  <div class="d-flex gap-2">
  </div>
</div>

<!-- Formulário de filtro -->
<div class="card mb-4">
  <div class="card-header bg-light border-bottom">
      <h5 class="mb-0"><i class="bi bi-search"></i> Filtros</h5>
  </div>
  <div class="card-body">
    <%= form_with url: invoices_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-3">
        <%= f.label :id, "ID do Lançamento", class: "form-label" %>
        <%= f.number_field :id, value: params[:id], class: "form-control" %>
      </div>

      <div class="col-md-3">
        <%= f.label :supplier_cnpj, "CNPJ do Fornecedor", class: "form-label" %>
        <%= f.text_field :supplier_cnpj, value: params[:supplier_cnpj], class: "form-control" %>
      </div>

      <div class="col-md-3">
        <%= f.label :date_issued, "Data de Emissão", class: "form-label" %>
        <%= f.date_field :date_issued, value: params[:date_issued], class: "form-control" %>
      </div>

      <div class="col-md-3">
        <%= f.label :due_date, "Data de Vencimento", class: "form-label" %>
        <%= f.date_field :due_date, value: params[:due_date], class: "form-control" %>
      </div>

<div class="col-md-3">
  <%= f.label :total, "Valor", class: "form-label" %>
  <div class="input-group">
    <span class="input-group-text">R$</span>
    <%= f.text_field :total, value: params[:total], type: "number", step: "0.01", placeholder: "0,00", class: "form-control" %>
  </div>
</div>

      <div class="col-md-3">
        <%= f.label :budget_category_id, "Categoria Orçamentária", class: "form-label" %>
        <%= f.collection_select :budget_category_id,
            BudgetCategory.order(:name),
            :id,
            :name,
            { prompt: "Selecione a categoria", selected: params[:budget_category_id] },
            { class: "form-select" } %>
      </div>

      <div class="col-md-3">
        <%= f.label :cost_center_id, "Centro de Custo", class: "form-label" %>
        <%= f.collection_select :cost_center_id,
            CostCenter.all.order(:name),
            :id,
            :name,
            { prompt: "Selecione o centro de custo", selected: params[:cost_center_id] },
            class: "form-select" %>
      </div>

      <div class="col-md-3">
        <%= f.label :invoice_number, "Número da NF", class: "form-label" %>
        <%= f.text_field :invoice_number, value: params[:invoice_number], class: "form-control" %>
      </div>

      <div class="col-12 mt-2">
        <%= f.submit "Filtrar", class: "btn btn-outline-primary" %>
        <%= link_to "Limpar", invoices_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Tabela de invoices -->
<div class="card shadow-sm rounded mb-4">
  <div class="card-header bg-light border-bottom">
      <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Contas Lançadas</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Código</th>
            <th>Fornecedor (CNPJ)</th>
            <th>Centro de Custo</th>
            <th>Categoria</th>
            <th>Data Emissão</th>
            <th>Data Vencimento</th>
            <th>Total</th>
            <th>Notas Fiscais</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <% @invoices.each do |invoice| %>
            <tr>
              <td><%= invoice.code %></td>
              <td><%= invoice.supplier.name %> (<%= invoice.supplier.cnpj %>)</td>
              <td><%= invoice.cost_center.name if invoice.cost_center %></td>
              <td><%= invoice.budget_category.name if invoice.budget_category %></td>
              <td><%= invoice.date_issued %></td>
              <td><%= invoice.due_date %></td>
              <td>R$ <%= number_with_precision(invoice.total, precision: 2, delimiter: ".") %></td>
              <td><%= truncated_list(invoice.invoice_numbers, :number, 2) %></td>
              <td>
                <% if invoice.document_urls.present? %>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" id="dropdownMenuButton<%= invoice.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-download"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton<%= invoice.id %>">
                      <% invoice.document_urls.each_with_index do |url, index| %>
                        <li>
                          <%= link_to download_document_invoice_path(invoice, document_index: index),
                                      class: "dropdown-item",
                                      data: { turbo: false } do %>
                            <i class="fas fa-file"></i> Documento <%= index + 1 %>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                <% else %>
                  <span>-</span>
                <% end %>
              </td>
              <td>
                <div class="d-inline-flex gap-2">
                  <%= link_to "Ver", invoice, class: "btn btn-sm btn-outline-secondary" %>
                  <%= link_to "Editar", edit_invoice_path(invoice), class: "btn btn-sm btn-outline-primary" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="d-flex align-items-center">
        <%= form_with url: invoices_path, method: :get, local: true, html: { class: "d-flex align-items-center mb-0" } do %>
          <% params.each do |key, value| %>
            <% unless ["per_page", "page", "commit"].include?(key) %>
              <%= hidden_field_tag key, value %>
            <% end %>
          <% end %>

          <label for="per_page" class="me-2 mb-0 text-nowrap">Itens por página:</label>
          <%= select_tag :per_page,
              options_for_select([5, 10, 20, 50], params[:per_page] || 10),
              class: "form-select form-select-sm me-2",
              onchange: "this.form.submit();" %>
          <% end %>
      </div>

      <div>
        <nav aria-label="Page navigation">
          <ul class="pagination mb-0">
            <% (1..@total_pages).each do |page| %>
              <li class="page-item <%= 'active' if page == @current_page %>">
                <%= link_to page, params.permit!.merge(page: page, per_page: params[:per_page] || 10), class: "page-link" %>
              </li>
            <% end %>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
<%= link_to "Voltar", root_path, class: "btn btn-primary shadow-sm p-3 w-100 mt-2" %>
